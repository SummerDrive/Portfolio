# GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
gcloud config set project polar-fulcrum-358119

# API æœ‰åŠ¹åŒ–
gcloud services enable run.googleapis.com artifactregistry.googleapis.com pubsub.googleapis.com cloudscheduler.googleapis.com

ğŸ”¹ ã‚¹ãƒ†ãƒƒãƒ— 2. Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªä½œæˆï¼ˆã¾ã ãªã„å ´åˆï¼‰

gcloud artifacts repositories create my-docker-repo --repository-format=docker --location=asia-northeast1 --description="Docker repo for Cloud Run service"

ã€Œ1,py.pandaså°†æ¥ã‚¨ãƒ©ãƒ¼â†’ ser[0] ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã‚‹éƒ¨åˆ†ã‚’ ser.iloc[0] ã«ä¿®æ­£ã™ã‚Œã°è­¦å‘Šã¯æ¶ˆãˆã¾ã™ã€‚
2,Flask ã®è­¦å‘Š

WARNING: This is a development server. Do not use it in a production deployment.


Cloud Run ä¸Šã§ flask run ã‚’ç›´æ¥èµ·å‹•ã—ã¦ã„ã‚‹ãŸã‚ã«å‡ºã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯æ–™é‡‘ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ãŒã€æœ¬ç•ªç’°å¢ƒå‘ã‘ã«ã¯ Gunicorn ç­‰ã‚’ä½¿ã†ã¹ãã¨ Flask ãŒè­¦å‘Šã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
â†’ Dockerfile ã‚’ä¿®æ­£ã—ã¦ gunicorn -b :8080 getDevAndPop:app ã®ã‚ˆã†ã«ã™ã‚‹ã®ãŒæ¨å¥¨ã§ã™ã€‚
3,ç„¡é§„ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ã®å¯èƒ½æ€§
Cloud Run ã¯ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã¨ãã«è‡ªå‹•ã§èµ·å‹• â†’ ä¸€å®šæ™‚é–“å¾…æ©Ÿ â†’ åœæ­¢ã€ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

è¤‡æ•°å›ã‚¨ãƒ©ãƒ¼ã‚„ãƒªãƒˆãƒ©ã‚¤ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã®ãŸã³ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç«‹ã¡ä¸ŠãŒã‚Š æ–™é‡‘ãŒä½™è¨ˆã«ã‹ã‹ã‚‹å¯èƒ½æ€§ ãŒã‚ã‚Šã¾ã™ã€‚

ç‰¹ã« Pub/Sub Push å‹ã¯ã€Œå‡¦ç†ãŒ 200 ã‚’è¿”ã•ãªã„ã€ã¨å†è©¦è¡Œ â†’ ç„¡é™ã«å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

â†’ è§£æ±ºç­–:

ã‚³ãƒ¼ãƒ‰ã§ä¾‹å¤–ã‚’æ¡ã‚Šã¤ã¶ã•ãšã€ç¢ºå®Ÿã« return "OK", 200 ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã€‚

ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†ä¸èƒ½ãªå ´åˆã¯ Dead Letter Queue (DLQ) ã«é€ã‚‹è¨­å®šã‚’ã—ã¦ãŠãã€‚
å†pandas è­¦å‘Šä¿®æ­£

# NG: Series.__getitem__ï¼ˆè­¦å‘Šï¼‰
array = [numAndUrl[0]]

# OK: iloc ã‚’æ˜ç¤º
array = [numAndUrl.iloc[0]]


â†’ å°†æ¥ã®ã‚¨ãƒ©ãƒ¼åŒ–ã‚’é¿ã‘ã‚‹ + è­¦å‘Šãƒ­ã‚°å‰Šæ¸›ã€‚

Gunicorn ã§æœ¬ç•ªé‹ç”¨
Dockerfile ã® CMD ã‚’ä»¥ä¸‹ã«å¤‰æ›´ï¼š

CMD exec gunicorn --bind :8080 --workers 1 --threads 8 getDevAndPop:app


â†’ Flask é–‹ç™ºã‚µãƒ¼ãƒã®è­¦å‘Šè§£æ¶ˆ + ãƒ¡ãƒ¢ãƒªç®¡ç†æ”¹å–„ã€‚

ãƒ¡ãƒ¢ãƒªåˆ¶å¾¡

Cloud Run ã®ãƒ¡ãƒ¢ãƒªã‚’ä¸€æ™‚çš„ã« 2GB ã«å¢—åŠ ï¼ˆèª²é‡‘ã¯å°‘ã—ä¸ŠãŒã‚‹ï¼‰ã€‚

ãã®ã†ãˆã§ã€Playwright ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¯å›æ–°è¦ã«ä½œã‚‹ã®ã§ã¯ãªã å‡¦ç†å¾Œã«æ˜ç¤ºçš„ã« browser.close() ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚

browser = p.chromium.launch()
page = browser.new_page()
page.goto(numAndUrl.iloc[1], wait_until="domcontentloaded")
# ... å‡¦ç† ...
browser.close()  # â† ã“ã‚Œã‚’å¿…ãšå®Ÿè¡Œ


Pub/Sub ã® Dead Letter Queue (DLQ) è¨­å®š

ãƒ¡ãƒ¢ãƒªè½ã¡ãªã©ã§ 200 ã‚’è¿”ã›ãªã„å ´åˆã€ç„¡é™ãƒªãƒˆãƒ©ã‚¤ã›ãšã« åˆ¥ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹: my-dead-letter-topicï¼‰ã«è»¢é€ã™ã‚‹ã€‚

ãã“ã§å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼ã§ãã‚‹ã®ã§ã€Œæ–™é‡‘çˆ†ç™ºã€ã‚’é˜²ã’ã‚‹ã€‚ã€

3. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ & Cloud Build ã§ push
gcloud builds submit --tag asia-northeast1-docker.pkg.dev/polar-fulcrum-358119/my-docker-repo/my-service

4. Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy my-service --image asia-northeast1-docker.pkg.dev/polar-fulcrum-358119/my-docker-repo/my-service:latest --region asia-northeast1
 (--no-allow-unauthenticated)å¤‰æ›´ã®å¿…è¦ã‚ã‚Šï¼ˆã“ã®ã¾ã¾ã ã¨å¤–éƒ¨htmlãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¤ã‘ã¦ã—ã¾ã†ï¼‰

(ä»¥ä¸‹æ–‡ç« ãã®ã¾ã¾ã€shellã§å®Ÿè¡Œ
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
PROJECT_ID=$(gcloud config get-value project)

# Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¤‰æ•°ã«ã‚»ãƒƒãƒˆ
SERVICE_ACCOUNT=$(gcloud run services describe my-service \
  --region=asia-northeast1 \
  --format='value(spec.template.spec.serviceAccountName)')

# Cloud Storage ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member=serviceAccount:$SERVICE_ACCOUNT \
  --role=roles/storage.objectAdmin
ä»¥ä¸Šæ–‡ç« ãã®ã¾ã¾ï¼‰

ï¼ƒAã€Œå¿…è¦ãªè¨­å®šã¾ã¨ã‚ï¼ˆ<> ã‚’åŸ‹ã‚ã‚‹ç®‡æ‰€ä»˜ãï¼‰
â‘  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·ã‚’å–å¾—
PROJECT_ID=polar-fulcrum-358119
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")

â‘¡ Pub/Sub ãƒˆãƒ”ãƒƒã‚¯ä½œæˆ
gcloud pubsub topics create my-topic   # ä¾‹: my-topic

â‘¢ Cloud Run ã« Pub/Sub ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‘¼ã³å‡ºã—æ¨©é™ã‚’ä»˜ä¸
gcloud run services add-iam-policy-binding <Cloud Run ã‚µãƒ¼ãƒ“ã‚¹å> \
  --region=<ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸãƒªãƒ¼ã‚¸ãƒ§ãƒ³> \
  --member=serviceAccount:service-$PROJECT_NUMBER@gcp-sa-pubsub.iam.gserviceaccount.com \
  --role=roles/run.invoker


ä¾‹ï¼š

gcloud run services add-iam-policy-binding my-service \
  --region=asia-northeast1 \
  --member=serviceAccount:service-$PROJECT_NUMBER@gcp-sa-pubsub.iam.gserviceaccount.com \
  --role=roles/run.invoker

â‘£ Pub/Sub ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
gcloud pubsub subscriptions create <ä»»æ„ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å> \
  --topic=<ãƒˆãƒ”ãƒƒã‚¯å> \
  --push-endpoint=https://<Cloud Run ã‚µãƒ¼ãƒ“ã‚¹URL>/ \
  --push-auth-service-account=<PROJECT_ID>@appspot.gserviceaccount.com


ä¾‹ï¼š

gcloud pubsub subscriptions create my-sub \
  --topic=my-topic \
  --push-endpoint=https://my-service-556105548619.asia-northeast1.run.app/ \
  --push-auth-service-account=polar-fulcrum-358119@appspot.gserviceaccount.com

â‘¤ Cloud Scheduler ã§å®šæœŸå®Ÿè¡Œã‚’è¨­å®š
gcloud scheduler jobs create pubsub <ä»»æ„ã®ã‚¸ãƒ§ãƒ–å> \
  --schedule "*/30 * * * *" \
  --topic=<ãƒˆãƒ”ãƒƒã‚¯å> \
  --message-body="trigger"


ä¾‹ï¼š

gcloud scheduler jobs create pubsub my-job \
  --schedule "*/30 * * * *" \
  --topic=my-topic \
  --message-body="trigger"


âœ… ã¾ã¨ã‚ã‚‹ã¨ã€ã‚ãªãŸã®ã‚±ãƒ¼ã‚¹ã§ã¯ <PROJECT_ID>@appspot.gserviceaccount.com ã‚’ $SERVICE_ACCOUNT ã®ä»£ã‚ã‚Šã«æ›¸ã‘ã°OKã§ã™ã€‚ã€ï¼ƒA

ï¼ƒBã€Œâœ… ã‚¹ãƒ†ãƒƒãƒ— 1: Scheduler ã®ã‚¸ãƒ§ãƒ–ç¢ºèª

Scheduler ã‚¸ãƒ§ãƒ–ãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

gcloud scheduler jobs list --location=asia-northeast1


å‡ºåŠ›ä¾‹ï¼š

ID       LOCATION          SCHEDULE          TARGET_TYPE
my-job   asia-northeast1   */30 * * * *      PUBSUB


SCHEDULE ãŒ "*/30 * * * *" ã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ã€‚

âœ… ã‚¹ãƒ†ãƒƒãƒ— 2: æ‰‹å‹•ã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹

å¾…ãŸãšã«ã™ããƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã‚¸ãƒ§ãƒ–ã‚’æ‰‹å‹•å®Ÿè¡Œã§ãã¾ã™ã€‚

gcloud scheduler jobs run my-job --location=asia-northeast1


ã“ã‚Œã§å³åº§ã« Pub/Sub ãƒˆãƒ”ãƒƒã‚¯ã« "trigger" ãŒé€ã‚‰ã‚Œã¾ã™ã€‚

âœ… ã‚¹ãƒ†ãƒƒãƒ— 3: Cloud Run å´ã®ãƒ­ã‚°ã‚’ç¢ºèª

Cloud Run ãŒå®Ÿéš›ã«å‘¼ã°ã‚ŒãŸã‹ã¯ãƒ­ã‚°ã§ç¢ºèªã—ã¾ã™ã€‚

gcloud logs read --project=<PROJECT_ID> \
  --region=asia-northeast1 \
  --service=my-service \
  --limit=20

[
gcloud logs read --project=polar-fulcrum-358119 \
  --region=asia-northeast1 \
  --service=my-service \
  --limit=20
]

Pub/Sub ã‹ã‚‰ push ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Œã°ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¾ã™

Python ã‚³ãƒ¼ãƒ‰å†…ã« print() ã‚’å…¥ã‚Œã¦ã„ã‚Œã°ã€ãã®å‡ºåŠ›ã‚‚ãƒ­ã‚°ã«æ®‹ã‚Šã¾ã™

ï¼ˆã‚‚ã£ã¨è¦‹ã‚„ã™ãã—ãŸã„å ´åˆã¯ Cloud Console â†’ Cloud Run â†’ my-service â†’ ãƒ­ã‚° ã‚’é–‹ã„ã¦GUIã§ç¢ºèªã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ï¼‰

âœ… è¿½åŠ : Pub/Sub ã®é…ä¿¡ç¢ºèª

ã‚‚ã— Cloud Run ã®ãƒ­ã‚°ã«ä½•ã‚‚å‡ºã¦ã“ãªã‹ã£ãŸã‚‰ã€Pub/Sub å´ã®ãƒ­ã‚°ã‚‚ç¢ºèªã§ãã¾ã™ã€‚

gcloud pubsub subscriptions pull my-sub --limit=5 --auto-ack


ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ®‹ã£ã¦ã„ã‚Œã°è³¼èª­å‡¦ç†ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ğŸ“Œ ã¾ã¨ã‚ã‚‹ã¨ï¼š

gcloud scheduler jobs list ã§ã‚¸ãƒ§ãƒ–ç¢ºèª

gcloud scheduler jobs run ã§æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

gcloud logs read ã§ Cloud Run å´ã®åå¿œã‚’è¦‹ã‚‹

ğŸ‘‰ ã“ã“ã¾ã§ç¢ºèªã™ã‚Œã°ã€Œç¢ºå®Ÿã« Scheduler â†’ Pub/Sub â†’ Cloud Run ãŒã¤ãªãŒã£ã¦ã„ã‚‹ã€ã“ã¨ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

è©¦ã—ã¦ã¿ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ã€å®Ÿéš›ã® Cloud Run ã®ãƒ­ã‚°ã®è¦‹æ–¹ï¼ˆGUIã‚¹ã‚¯ã‚·ãƒ§ä»˜ãæ‰‹é †ï¼‰ ã‚’è©³ã—ãçŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿã€ï¼ƒB


ex.ï¼‘å›å®Ÿè¡Œ
curl -X POST "https://my-service-556105548619.asia-northeast1.run.app" -H "Authorization: Bearer $(gcloud auth print-identity-token)" -H "Content-Type: application/json" -d '{"test": true}'

1. å¿…é ˆãƒ¡ãƒ¢
é …ç›®	ç†ç”±
GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID	gcloud ã‚³ãƒãƒ³ãƒ‰ã‚„ Scheduler è¨­å®šã§å¿…é ˆ
Cloud Run ã‚µãƒ¼ãƒ“ã‚¹å	ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æŒ‡å®šã™ã‚‹ãŸã‚
Cloud Run URL	Scheduler ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆã«ãªã‚‹
ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå	Scheduler ã‹ã‚‰å‘¼ã³å‡ºã™å ´åˆã«å¿…è¦ (roles/run.invoker ã‚’ä»˜ä¸)
2. æ¨å¥¨ãƒ¡ãƒ¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
é …ç›®	ç†ç”±
Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªå / ã‚¤ãƒ¡ãƒ¼ã‚¸å	å¾Œã§æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ push ã™ã‚‹ã¨ãå‚ç…§
æœ€æ–°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚„ digest (sha256)	ã€Œæœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å›ºå®šã—ãŸã„ã€å ´åˆã‚„ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã«å¿…è¦
Dockerfile / requirements.txt ã®å ´æ‰€	å†ãƒ“ãƒ«ãƒ‰æ™‚ã«å‚ç…§
CSV ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚±ãƒƒãƒˆ / ãƒ•ã‚¡ã‚¤ãƒ«å	process_csv ãŒèª­ã¿è¾¼ã‚€ãŸã‚