gcpã«ã‚ˆã‚‹pythonå®šæœŸå®Ÿè¡Œ
ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
import os
import time
import re
import pandas as pd
from flask import Flask, request, jsonify
from playwright.sync_api import sync_playwright
scheduler,pub/sub/cloud runä½¿ç”¨
csv1.csvã®å…ˆé ­æ•°è¡Œã‚’å‚ç…§ã—ã¦pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ>csv2.csvã«çµæœã‚’è¿½åŠ >csv1ã®å‚ç…§ã—ãŸéƒ¨åˆ†ã‚’å‰Šé™¤

1ï¸.Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æˆï¼ˆCloud Run å¯¾å¿œï¼‰

Cloud Run ã§ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦å‡¦ç†ã™ã‚‹ Web ã‚µãƒ¼ãƒãƒ¼ ãŒå¿…è¦ã§ã™ã€‚
Flask ã‚’ä½¿ã£ã¦ process_csv ã‚’ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚

å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
# main.py
import os
import time
import re
import pandas as pd
from flask import Flask, request, jsonify
from playwright.sync_api import sync_playwright

app = Flask(__name__)

# å…ƒã€…ã®å‡¦ç†ã‚’é–¢æ•°ã¨ã—ã¦å®šç¾©
def process_csv():
    # ä¾‹: csv1.csv ã®å…ˆé ­æ•°è¡Œã‚’å‡¦ç†
    df1 = pd.read_csv("csv1.csv")
    n = 5  # å…ˆé ­5è¡Œå‡¦ç†
    df_to_process = df1.head(n)
    
    # ã“ã“ã« Playwright ã‚„å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()
        # ãƒšãƒ¼ã‚¸æ“ä½œä¾‹
        # page.goto("https://example.com")
        browser.close()
    
    # çµæœã‚’ csv2.csv ã«è¿½åŠ 
    if os.path.exists("csv2.csv"):
        df_result = pd.read_csv("csv2.csv")
        df_result = pd.concat([df_result, df_to_process])
    else:
        df_result = df_to_process
    df_result.to_csv("csv2.csv", index=False)
    
    # å…ƒ CSV ã®å…ˆé ­ n è¡Œã‚’å‰Šé™¤
    df_remaining = df1.iloc[n:]
    df_remaining.to_csv("csv1.csv", index=False)

@app.route("/", methods=["POST"])
def handle_request():
    try:
        process_csv()
        return jsonify({"status": "success"}), 200
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)

2ï¸.Dockerfileï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰å¯èƒ½ï¼‰
# Playwright å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆPython + Chromium ä»˜ãï¼‰
FROM mcr.microsoft.com/playwright/python:latest

WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ã‚¢ãƒ—ãƒªã‚½ãƒ¼ã‚¹ã‚³ãƒ”ãƒ¼
COPY . .

# Cloud Run ãƒãƒ¼ãƒˆ
ENV PORT 8080
EXPOSE 8080

# Flask ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
CMD ["python", "main.py"]


requirements.txt ã¯ä»¥ä¸‹ã‚’å«ã‚€ä¾‹ï¼š

Flask==2.3.2
pandas==2.1.1
playwright==1.42.0


å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚è¿½åŠ ã€‚

3ï¸.ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« PC ã§ Docker æ§‹ç¯‰ï¼‰

Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰

docker build -t asia-northeast1-docker.pkg.dev/polar-fulcrum-358119/my-repo/my-func:latest .


Artifact Registry ã« push

docker push asia-northeast1-docker.pkg.dev/polar-fulcrum-358119/my-repo/my-func:latest


Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤

gcloud run deploy my-func --image=asia-northeast1-docker.pkg.dev/polar-fulcrum-358119/my-repo/my-func:latest --region=asia-northeast1 --platform=managed --allow-unauthenticated

4ï¸âƒ£ å®šæœŸå®Ÿè¡Œï¼ˆScheduler + Pub/Subï¼‰

Pub/Sub ãƒˆãƒ”ãƒƒã‚¯ä½œæˆ

gcloud pubsub topics create my-topic


Cloud Scheduler ã§ Pub/Sub ã«å®šæœŸçš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡

gcloud scheduler jobs create pubsub my-job --schedule="*/5 * * * *" --topic=my-topic --message-body="run"


Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚’ Pub/Sub push ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§ç™»éŒ²

gcloud pubsub subscriptions create my-subscription --topic=my-topic --push-endpoint=https://<CLOUD_RUN_URL>/ --push-auth-service-account=<SERVICE_ACCOUNT_EMAIL>


ã“ã‚Œã§ CSV å‡¦ç†ã‚’å®šæœŸå®Ÿè¡Œ ã§ãã¾ã™ã€‚

ğŸ”¹ ã¾ã¨ã‚ãƒã‚¤ãƒ³ãƒˆ

Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ Flask ã§ HTTP ãƒ©ãƒƒãƒ‘ãƒ¼åŒ–

Dockerfile ã¯ Cloud Run å‘ã‘ã«ãƒãƒ¼ãƒˆ 8080 æŒ‡å®š

Docker ã¯ãƒ­ãƒ¼ã‚«ãƒ« PC ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ Artifact Registry ã« push

Pub/Sub + Cloud Scheduler ã§å®šæœŸå®Ÿè¡Œ