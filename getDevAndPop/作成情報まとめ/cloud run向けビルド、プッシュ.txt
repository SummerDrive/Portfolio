# GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
gcloud config set project polar-xxxxxx

# API æœ‰åŠ¹åŒ–
gcloud services enable run.googleapis.com artifactregistry.googleapis.com pubsub.googleapis.com cloudscheduler.googleapis.com

ğŸ”¹ ã‚¹ãƒ†ãƒƒãƒ— 2. Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªä½œæˆï¼ˆã¾ã ãªã„å ´åˆï¼‰

gcloud artifacts repositories create my-docker-repo --repository-format=docker --location=asia-northeast1 --description="Docker repo for Cloud Run service"

ã€Œ1,py.pandaså°†æ¥ã‚¨ãƒ©ãƒ¼â†’ ser[0] ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã‚‹éƒ¨åˆ†ã‚’ ser.iloc[0] ã«ä¿®æ­£ã™ã‚Œã°è­¦å‘Šã¯æ¶ˆãˆã¾ã™ã€‚
2,Flask ã®è­¦å‘Š

WARNING: This is a development server. Do not use it in a production deployment.


Cloud Run ä¸Šã§ flask run ã‚’ç›´æ¥èµ·å‹•ã—ã¦ã„ã‚‹ãŸã‚ã«å‡ºã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯æ–™é‡‘ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ãŒã€æœ¬ç•ªç’°å¢ƒå‘ã‘ã«ã¯ Gunicorn ç­‰ã‚’ä½¿ã†ã¹ãã¨ Flask ãŒè­¦å‘Šã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
â†’ Dockerfile ã‚’ä¿®æ­£ã—ã¦ gunicorn -b :8080 getDevAndPop:app ã®ã‚ˆã†ã«ã™ã‚‹ã®ãŒæ¨å¥¨ã§ã™ã€‚
3,ç„¡é§„ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ã®å¯èƒ½æ€§
Cloud Run ã¯ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã¨ãã«è‡ªå‹•ã§èµ·å‹• â†’ ä¸€å®šæ™‚é–“å¾…æ©Ÿ â†’ åœæ­¢ã€ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

è¤‡æ•°å›ã‚¨ãƒ©ãƒ¼ã‚„ãƒªãƒˆãƒ©ã‚¤ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã®ãŸã³ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç«‹ã¡ä¸ŠãŒã‚Š æ–™é‡‘ãŒä½™è¨ˆã«ã‹ã‹ã‚‹å¯èƒ½æ€§ ãŒã‚ã‚Šã¾ã™ã€‚

ç‰¹ã« Pub/Sub Push å‹ã¯ã€Œå‡¦ç†ãŒ 200 ã‚’è¿”ã•ãªã„ã€ã¨å†è©¦è¡Œ â†’ ç„¡é™ã«å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

â†’ è§£æ±ºç­–:

ã‚³ãƒ¼ãƒ‰ã§ä¾‹å¤–ã‚’æ¡ã‚Šã¤ã¶ã•ãšã€ç¢ºå®Ÿã« return "OK", 200 ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã€‚

ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†ä¸èƒ½ãªå ´åˆã¯ Dead Letter Queue (DLQ) ã«é€ã‚‹è¨­å®šã‚’ã—ã¦ãŠãã€‚
å†pandas è­¦å‘Šä¿®æ­£

# NG: Series.__getitem__ï¼ˆè­¦å‘Šï¼‰
array = [numAndUrl[0]]

# OK: iloc ã‚’æ˜ç¤º
array = [numAndUrl.iloc[0]]


â†’ å°†æ¥ã®ã‚¨ãƒ©ãƒ¼åŒ–ã‚’é¿ã‘ã‚‹ + è­¦å‘Šãƒ­ã‚°å‰Šæ¸›ã€‚

Gunicorn ã§æœ¬ç•ªé‹ç”¨
Dockerfile ã® CMD ã‚’ä»¥ä¸‹ã«å¤‰æ›´ï¼š

CMD exec gunicorn --bind :8080 --workers 1 --threads 8 getDevAndPop:app


â†’ Flask é–‹ç™ºã‚µãƒ¼ãƒã®è­¦å‘Šè§£æ¶ˆ + ãƒ¡ãƒ¢ãƒªç®¡ç†æ”¹å–„ã€‚

ãƒ¡ãƒ¢ãƒªåˆ¶å¾¡

Cloud Run ã®ãƒ¡ãƒ¢ãƒªã‚’ä¸€æ™‚çš„ã« 2GB ã«å¢—åŠ ï¼ˆèª²é‡‘ã¯å°‘ã—ä¸ŠãŒã‚‹ï¼‰ã€‚

ãã®ã†ãˆã§ã€Playwright ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¯å›æ–°è¦ã«ä½œã‚‹ã®ã§ã¯ãªã å‡¦ç†å¾Œã«æ˜ç¤ºçš„ã« browser.close() ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚

browser = p.chromium.launch()
page = browser.new_page()
page.goto(numAndUrl.iloc[1], wait_until="domcontentloaded")
# ... å‡¦ç† ...
browser.close()  # â† ã“ã‚Œã‚’å¿…ãšå®Ÿè¡Œ


Pub/Sub ã® Dead Letter Queue (DLQ) è¨­å®š

ãƒ¡ãƒ¢ãƒªè½ã¡ãªã©ã§ 200 ã‚’è¿”ã›ãªã„å ´åˆã€ç„¡é™ãƒªãƒˆãƒ©ã‚¤ã›ãšã« åˆ¥ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹: my-dead-letter-topicï¼‰ã«è»¢é€ã™ã‚‹ã€‚

ãã“ã§å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼ã§ãã‚‹ã®ã§ã€Œæ–™é‡‘çˆ†ç™ºã€ã‚’é˜²ã’ã‚‹ã€‚ã€

3. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ & Cloud Build ã§ push
gcloud builds submit --tag asia-northeast1-docker.pkg.dev/polar-xxxxxx/my-docker-repo/my-service

4. Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy my-service --image asia-northeast1-docker.pkg.dev/polar-xxxxxx/my-docker-repo/my-service:latest --region asia-northeast1
 (--no-allow-unauthenticated)å¤‰æ›´ã®å¿…è¦ã‚ã‚Šï¼ˆã“ã®ã¾ã¾ã ã¨å¤–éƒ¨htmlãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¤ã‘ã¦ã—ã¾ã†ï¼‰

(ä»¥ä¸‹æ–‡ç« ãã®ã¾ã¾ã€shellã§å®Ÿè¡Œ
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
PROJECT_ID=$(gcloud config get-value project)

# Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¤‰æ•°ã«ã‚»ãƒƒãƒˆ
SERVICE_ACCOUNT=$(gcloud run services describe my-service \
  --region=asia-northeast1 \
  --format='value(spec.template.spec.serviceAccountName)')

# Cloud Storage ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member=serviceAccount:$SERVICE_ACCOUNT \
  --role=roles/storage.objectAdmin
ä»¥ä¸Šæ–‡ç« ãã®ã¾ã¾ï¼‰

ï¼ƒAã€Œå¿…è¦ãªè¨­å®šã¾ã¨ã‚ï¼ˆ<> ã‚’åŸ‹ã‚ã‚‹ç®‡æ‰€ä»˜ãï¼‰
â‘  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·ã‚’å–å¾—
PROJECT_ID=polar-xxxxxx
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")

â‘¡ Pub/Sub ãƒˆãƒ”ãƒƒã‚¯ä½œæˆ
gcloud pubsub topics create my-topic   # ä¾‹: my-topic
