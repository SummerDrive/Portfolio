docker build -t asia-northeast1-docker.pkg.dev/getdevandpop/my-repo/my-func:latest .
push するときも同じ名前で：

bash
コピーする
編集する
gcloud auth configure-docker asia-northeast1-docker.pkg.dev
docker push asia-northeast1-docker.pkg.dev/getdevandpop/my-repo/my-func:latest

gcloud functions deploy process_csv \
  --gen2 \
  --region=asia-northeast1 \
  --runtime=custom \
  --entry-point=process_csv \
  --trigger-topic=my-topic \
  --source=. \
  --docker-image=asia-northeast1-docker.pkg.dev/getdevandpop/my-repo/my-func:latest

1. Docker ビルド

作業フォルダ（main.py, requirements.txt, Dockerfile が置いてある場所）で：

docker build -t asia-northeast1-docker.pkg.dev/<PROJECT_ID>/my-repo/my-func:latest .

2. Artifact Registry へ push
docker push asia-northeast1-docker.pkg.dev/<PROJECT_ID>/my-repo/my-func:latest

3. Cloud Functions デプロイ
gcloud functions deploy my-func ^
  --gen2 ^
  --region=asia-northeast1 ^
  --runtime=python311 ^
  --trigger-topic=my-topic ^
  --entry-point=process_csv ^
  --docker-image=asia-northeast1-docker.pkg.dev/<PROJECT_ID>/my-repo/my-func:latest

>「Cloud Functions Gen 2 は内部的に Cloud Run 上で動作しており、
Docker イメージから直接デプロイする場合は、Cloud Run を使用するのが適切です。
以下の手順で、Artifact Registry の Docker イメージから Cloud Run サービスをデプロイできます

1. Cloud Run サービスのデプロイ
gcloud run deploy my-func ^
  --image=asia-northeast1-docker.pkg.dev/polar-fulcrum-358119/my-repo/my-func:latest ^
  --region=asia-northeast1 ^
  --platform=managed ^
  --allow-unauthenticated


--image: 使用する Docker イメージの URL

--region: デプロイ先のリージョン

--platform=managed: マネージド Cloud Run を使用

--allow-unauthenticated: 認証なしでアクセスを許可（必要に応じて調整）

2. Pub/Sub トリガーの設定（オプション）

Cloud Run サービスを Pub/Sub トリガーで起動する場合、以下の手順で設定します。

Pub/Sub トピックの作成（まだ作成していない場合）:

gcloud pubsub topics create my-topic


Cloud Run サービスへの Pub/Sub サブスクリプションの作成:

gcloud run services add-iam-policy-binding my-func ^
  --member=serviceAccount:$(gcloud projects describe polar-fulcrum-358119 --format='value(projectNumber)')-compute@developer.gserviceaccount.com ^
  --role=roles/pubsub.subscriber ^
  --region=asia-northeast1


Pub/Sub トピックと Cloud Run サービスの関連付け:

gcloud pubsub subscriptions create my-subscription ^
  --topic=my-topic ^
  --push-endpoint=https://my-func-<random-id>.a.run.app ^
  --push-auth-service-account=projects/polar-fulcrum-358119/serviceAccounts/my-func@polar-fulcrum-358119.iam.gserviceaccount.com


※ <random-id> は Cloud Run サービスの URL に含まれるランダムな識別子です。デプロイ後に確認できます。」